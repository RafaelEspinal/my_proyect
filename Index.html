<!DOCTYPE html>
<head>
    <title>System: Generar cerdula dominicana</title>
    <link rel="stylesheet" href = "css/bootstrap.min.css">
    <link rel="stylesheet" href = "css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="estilo.css">
    <script src="js/bootstrap.min.js"></script>
    <script src="html2canvas.js"></script>
    <script src="jquery-3.4.1.min.js"></script>
</head>
<body onload="cargarTodo();">
    <div class="container" >

        <div id="tableCedu" class="col-12"  >
            <div>
                <button onclick="btnRegresar();" class="btn btn-danger">
                    <i class="fa fa-chevron-left"> </i> Regresar
                </button>
            </div>
            <table class="table table-striped table-bordered table-hover">
                <thead >
                    <tr>
                        <th>Eliminar</th>
                        <th>Foto</th>
                        <th>Cedula</th>
                        <th>Nombre y apellido</th>
                        <th>Fecha de nacimiento</th>
                        <th>Lugar de nacimiento</th>
                        <th>Signo Zodiaco</th>
                        <th>Editar</th>
                    </tr>
                </thead>
                <tbody class="text-center" id="tbCedula" >
                    
                </tbody>
            </table>
        </div>
        <div class="row" id="todoAqui" style="position: relative; top: 100px;">
            <div class=" col-md-6 c-12 text-center">
                <div id='fotoCedu' class="mb-4">
                    <img id="foto2" class=" row-cols-3" style="width: 140px; height:140px;">
                    <div id="camara" class="video-wrap">
                        <video id="video" playsinline autoplay></video>
                        <canvas id="canvas" width="140" height="140"></canvas>
                    </div>
                    <div id="accede">
                        <button onclick="cambioFoto();" class="btn btn-outline-dark">
                            <i class="fa fa-camera"></i> Cambiar foto 
                        </button>     
                    </div>
                    <div id="captura" class="controller">
                        <button id="snap" class="btn btn-outline-dark">
                            <i class="fa fa-camera"></i> Capture
                        </button>
                    </div>
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span class="input-group-text">Cedula:</span>
                    </div>
                    <input name="entrada" id="cedula" class="form-control" type="text" >
                    <div>
                        <button id="buscarbtn" onclick="buscarCedula();" class="btn btn-outline-dark l-5"> 
                            <i class="fa fa-search"></i>Buscar
                        </button>
                    </div>
                </div>
                <div id="buscarHide">
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Nombre:</span>
                        </div>
                        <input name="entrada" id="nombre" class="form-control" type="text" >
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Lugar de nacimiento:</span>
                        </div>
                        <input name="entrada" id="lugar" class="form-control" type="text" >
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Fecha de nacimiento</span>
                        </div>
                        <input name="entrada" id="fecha" class="form-control" type="text" >
                    </div>
                    <div class="input-group mb-3">
                        <div class="input-group-prepend">
                            <span class="input-group-text">Signo Zodiaco</span>
                        </div>
                        <input name="entrada" id="signo" class="form-control" type="text" >
                    </div>
                     <button onclick="Agregar();" class="btn btn-outline-dark mb-3">
                         <i class="fa fa-cubes"></i> Generar cedula
                     </button>
                </div>
                </div>
            <div class=" col-md-6">
                <div id="myDiv" class=" esteBackground mb-3" style= "border-radius: 10px; height:270px;" >
                    <div class="row mb-3">
                        <div  class="col-md-4 col-xs-4 col-sm-4">
                            <img src="escudo.png" alt="Escudo[200x200]" style="position: relative;top: 10px; left: 25px; width: 40px; height: 40px;">
                            <img id="foto" class="border row-cols-3" style="position: relative; top: 30px; left: 25px; width: 140px; height:140px ;">
                            <p class="text-monospace" id="nombreApe" style="position: relative; top: 40px; left: 25px;">--</p>
                        </div>
                        <div class=" col-md-5 col-xs-5 col-sm-5">
                            <p class="text-monospace text-center" style="size: 2px; position: relative; left: -30px;">REPUBLICA DOMINICANA</p>
                            <p class="text-monospace text-center te" style=" position: relative;top: -20px; left: -30px;">JUNTA CENTRAL ELECTORAL</p>
                            <p class="text-monospace text-center" style="position: relative; top: -40px; font-size: 11px; left: -30px;"><strong>CEDULA  DE IDENTIDAD  Y  ELECTORAL</strong></p>
                            <p id="cedula1" style="font-size: 20px; font-weight: bold; position: relative; top: -60px; left: 70px;">--</p>
                            <p style="position: relative; top: -80px; font-weight: bold;">Lugar de nacimiento:</p>
                            <p id="lugarNacimiento" style="position: relative; top: -95px;">--</p>
                            <p style="position: relative; top: -110px; font-weight: bold;">Fecha de nacimiento:</p>
                            <p id="fechaNacimiento" style="position: relative; top: -125px;">--</p>
                            <p style="position: relative; top: -140px; font-weight: bold;">Signo de zodiaco:</p>
                            <p id="signoZodi"style="position: relative; top: -155px;">--</p>
                            <img id="fotoSigno"  style="position: relative; top: -193px; left: 120px; width: 45px; height:45px ;">
                        </div>
                        <div class="col-sm-3 col-xs-3">
                            <img src="jce.png" style="position: relative;top: 10px; left: 40px; width: 60px; height: 60px;" alt="">
                            <img id="foto1" style="position: relative; opacity: 0.5; top: 110px; left: 19px; width: 70px; height:80px ;">
                        </div>
                        
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-6">
                        <button onclick="descargaCedula()" id="down" class="btn btn-outline-dark">
                            <i class="fa fa-angle-double-down"></i> Descargar cedula
                        </button>
                    </div>
                    <div class="col-6">
                        <button onclick="listaDeCedulas()" id="seen" class="btn btn-outline-dark">
                            <i class="fa fa-id-card"></i> Mostrar cedulas
                        </button>
                    </div>
                </div>
                
            </div>
            
        </div>
    </div>
</body>
<script>
    guardadas=[];
    var foto_canvas;
    
    var cedula_editar= null;
    $('#buscarHide, #fotoCedu, #tableCedu').hide();

    function estadoNormal(){

    }

    async function buscarCedula(){
        cedula= $('#cedula').val();
        URL = "http://173.249.49.169:88/api/test/consulta/"+cedula;
        const resp = await fetch(URL);
        const data = await resp.json();

        if(data.Ok && cedula.length > 0){

            $('#buscarHide, #fotoCedu').show('slow');
            $('#buscarbtn').hide('slow');
            var obj = JSON.stringify(data);
            var entendi = JSON.parse(obj);
            $('#foto2').attr('src', entendi.Foto);
            $('#cedula').val(entendi.Cedula);
            $('#nombre').val(entendi.Nombres+" "+entendi.Apellido1+" "+entendi.Apellido2);
            $('#fecha').val(entendi.FechaNacimiento);
            $('#lugar').val(entendi.LugarNacimiento);
            $('#signo').val(signoZodiaco(entendi.FechaNacimiento));
        }else{
            alert("Debe digitar una cedula valida para buscar.");
        }
    }

    function Agregar(){
        datos={};
        $('#buscarbtn').show('slow');
        $('#buscarHide, #fotoCedu').hide('slow');
        datos.foto=foto_canvas;

        if(datos.foto == null){
            datos.foto= document.getElementById('foto2').src;
        }
        datos.cedula= $('#cedula').val();
        datos.nombre = $('#nombre').val();
        datos.fecha = $('#fecha').val();
        datos.lugar= $('#lugar').val();
        datos.signo = $('#signo').val();
        if(cedula_editar == null){
            guardadas.push(datos);
            if(foto_canvas!=null){
                foto_canvas=null;
            }
            
        }else{
            guardadas[cedula_editar]=datos;
            $('#buscarbtn').show('slow');
            $('#foto2, #accede').show('slow');
            
            $('#buscarHide, #fotoCedu, #canvas, #captura ').hide('slow');

            cedula_editar = null;
            if(foto_canvas!=null){
                foto_canvas=null;
            }
        }
        guardarTodo();
        mostrarCedula();
        limpiar();
    }

    function limpiar(){
        todoCampo= document.getElementsByName('entrada');
        for (k = 0; k<todoCampo.length; k++){
            campo= todoCampo[k];
            campo.value="";
        }
    }


    function mostrarCedula(){
        
        toDataURL(datos.foto, function(dataURL){
            $('#foto').attr('src', dataURL);
            $('#foto1').attr('src', dataURL);
        })
        $('#cedula1').html(datos.cedula);
        $('#nombreApe').html(datos.nombre);
        $('#lugarNacimiento').html(datos.lugar);
        $('#fechaNacimiento').html(datos.fecha);
        $('#signoZodi').html(datos.signo);   
         
    }

    function listaDeCedulas(){
        $('#tableCedu').show('slow');
        $('#todoAqui').hide('slow');
        

        destino = document.getElementById('tbCedula');
        destino.innerHTML= "";
        
        for(x = 0; x < guardadas.length; x++){
            ced = guardadas[x];
            tr = document.createElement('tr');
            td = document.createElement('td');
            btnDelete= document.createElement('button');
            btnDelete.setAttribute('class','btn btn-danger');
            btnDelete.setAttribute('onclick',"borrarCedula("+x+")");
            i1= document.createElement('i');
            i1.setAttribute('class','fa fa-trash');
            btnDelete.appendChild(i1);
            td.appendChild(btnDelete)
            tr.appendChild(td);
                
            for(key in ced){
                if(key=="foto"){
                    val= ced.foto;
                    td = document.createElement('td');
                    img= document.createElement('img');
                    img.setAttribute('style','width:100px; height: 100px;');
                    img.src = val;
                    td.appendChild(img);
                    tr.appendChild(td);
                }else{
                val = ced[key];
                td = document.createElement('td');
                td.innerHTML = val;
                tr.appendChild(td);
                }
            }
            td = document.createElement('td');
            btnEdit= document.createElement('button');
            btnEdit.setAttribute('class','btn btn-info');
            btnEdit.setAttribute('onclick',"editarCedula("+x+")");
            i= document.createElement('i');
            i.setAttribute('class','fa fa-edit');
            btnEdit.appendChild(i);
            td.appendChild(btnEdit)
            tr.appendChild(td)
            destino.appendChild(tr);
        }
    }
    function borrarCedula(Index){
        if(confirm("seguro que quiere borrar la cedula ?")){
            guardadas.splice(Index, 1);
            guardarTodo();
            listaDeCedulas();
        }

    }
    function editarCedula(Index){
        $('#tableCedu').hide('slow');
        $('#todoAqui').show('slow');
        $('#buscarHide, #fotoCedu').show('slow');
        $('#buscarbtn').hide('slow');
        cedula_editar= Index;
        cedu = guardadas[cedula_editar];
        for(k in cedu){
            if(k=="foto"){
                document.getElementById('foto2').src=cedu.foto;
            }else{
                document.getElementById(k).value=cedu[k];
            }
        }
    }

    function btnRegresar(){
        window.location= window.location;
    }

    function signoZodiaco(fecha){
        var signo;
        var month =  fecha;
        mes = month.substring(5, 7);

        var day =  fecha;
        dia = day.substring(8, 10);

        if (mes == 03 && dia >= 24 || mes == 04 && dia <= 21) {
            signo = "Aries"; 
            $('#fotoSigno').attr('src', "signo/aries.jpg");
            

        } else if (mes == 04 && dia >= 22 || mes == 05 && dia <= 21) {
            signo = "Tauros"; 
            $('#fotoSigno').attr('src', "signo/tauro.jpg")
            
        } else if (mes == 05 && dia >= 22 || mes == 06 && dia <= 21) {
            signo = "Geminis" ;
            $('#fotoSigno').attr('src', "signo/gemini.jpg")

        } else if (mes == 06 && dia >= 22 || mes == 07 && dia <= 21) {
           signo = "Cancer"; 
           $('#fotoSigno').attr('src', "signo/cancer.jpg")

        } else if (mes == 07 && dia >= 22 || mes == 08 && dia <= 22) {
            signo = "Leo"; 
            $('#fotoSigno').attr('src', "signo/leo.jpg")
      

        } else if (mes == 08 && dia >= 23 || mes == 09 && dia <= 21) {
            signo = "Virgo"; 
            $('#fotoSigno').attr('src', "signo/virgo.jpg")
    

        } else if (mes == 09 && dia >= 22 || mes == 10 && dia <= 21) {
            signo = "Libra"; 
            $('#fotoSigno').attr('src', "signo/libra.jpg")
            

        } else if (mes == 10 && dia >= 22 || mes == 11 && dia <= 22) {
            signo = "Escorpion"; 
            $('#fotoSigno').attr('src', "signo/escorpion.jpg")
      

        } else if (mes == 11 && dia >= 23 || mes == 12 && dia <= 21) {
            signo = "Sagitario";
            $('#fotoSigno').attr('src', "signo/sagitario.jpg")
         

        } else if (mes == 12 && dia >= 22 || mes == 01 && dia <= 21) {
            signo = "Capricornio";
            $('#fotoSigno').attr('src', "signo/capricornio.jpg")
        

        } else if (mes == 01 && dia >= 22 || mes == 02 && dia <= 21) {
            signo = "Acuario";
            $('#fotoSigno').attr('src', "signo/acuario.jpg")
       
        } else if (mes == 02 && dia >= 22 || mes == 03 && dia <= 23) {
            signo = "Pisces";
            $('#fotoSigno').attr('src', "signo/pisis.jpg")
           
        }
        return signo;
    }
    
    function descargaCedula(){
        html2canvas($("#myDiv"), {
            userCORS:true,
        onrendered: function(canvas) {
            saveAs(canvas.toDataURL(), datos.cedula+'.jpg');
            }
        });
        function saveAs(uri, filename) {
            var link = document.createElement('a');
            if (typeof link.download === 'string') {
                link.href = uri;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                window.open(uri);
            }
        }
    }

    function toDataURL(src, callback){
        var xhttp = new XMLHttpRequest();
        

        xhttp.onload = function(){
            var fileReader = new FileReader();
            fileReader.onloadend = function(){
                callback(fileReader.result);
            };
            fileReader.readAsDataURL(xhttp.response);
        }; 

        xhttp.responseType = 'blob';
        xhttp.open('GET', src, true);
        xhttp.send();
    }
    
    $("#video").hide();
    $("#captura").hide();
    $("#canvas").hide();

    function cambioFoto(){
    $("#foto2").hide();
    $("#accede").hide();
    $("#video").show();
    $("#captura").show();
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snap = document.getElementById("snap");
    const errorMsgElement = document.querySelector('span#errorMsg');

    const constraints = {
        video: {
            width: 140, height: 140
        }
    };

    async function init() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        handleSuccess(stream);
        
    } catch (e) {
        errorMsgElement.innerHTML = `navigator.getUserMedia error:${e.toString()}`;
    }
    }

    function handleSuccess(stream) {
    window.stream = stream;
    video.srcObject = stream;
    }

    init();

    var context = canvas.getContext('2d');
    snap.addEventListener("click", function() {
            $("#video").hide();
            $("#canvas").show();
            context.drawImage(video, 0, 0, 140, 140);
            video.src="";
            video.style.display="none";
            stream.getVideoTracks()[0].stop(); 
            foto_canvas=canvas.toDataURL();
        });   
    }
   
   function guardarTodo(){
       localStorage.setItem('Cedulas', JSON.stringify(guardadas));
   }

   function cargarTodo(){
        tmp = localStorage.getItem('Cedulas');
        if(tmp != null){
            guardadas = JSON.parse(tmp);
        }
    }
</script>
</html>